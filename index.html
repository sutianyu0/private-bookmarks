<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç§äººå¯¼èˆªé—¨æˆ· | AI Powered Dashboard</title>
  <style>
    :root {
      --bg: #050810;
      --panel: rgba(17, 25, 40, 0.75);
      --card: rgba(25, 35, 55, 0.6);
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.5);
      --ai-accent: #8b5cf6;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
      --radius-lg: 20px;
      --radius-md: 12px;
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; transition: all 0.2s ease; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #lock-screen {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(20px);
    }
    .lock-box {
      background: var(--panel);
      padding: 40px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      text-align: center;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      width: 100%;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .brand h1 {
      margin: 0;
      font-size: 24px;
      background: linear-gradient(to right, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .search-bar {
      display: flex;
      align-items: center;
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 99px;
      width: 100%;
      max-width: 400px;
    }
    .search-bar input {
      background: transparent;
      border: none;
      color: white;
      padding: 8px;
      width: 100%;
      outline: none;
    }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      background: var(--panel);
      border: 1px solid var(--border);
      color: white;
      padding: 10px 18px;
      border-radius: 99px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .btn:hover { background: var(--border); transform: translateY(-2px); }
    .btn:active { transform: translateY(0); }
    .btn-primary { background: var(--accent); border-color: var(--accent); }
    .btn-ai { 
        background: linear-gradient(135deg, #6366f1, #8b5cf6); 
        border: none;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    .btn-ai:hover { box-shadow: 0 6px 16px rgba(139, 92, 246, 0.5); }

    .category-section { margin-bottom: 40px; }
    .category-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    .category-header h2 { font-size: 18px; margin: 0; font-weight: 500; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 20px;
      position: relative;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      gap: 12px;
      backdrop-filter: blur(10px);
    }
    .card:hover {
      border-color: var(--accent);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
    }

    .card-top { display: flex; align-items: center; gap: 12px; }
    .favicon {
      width: 32px; height: 32px; border-radius: 8px;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .favicon img { width: 100%; height: 100%; object-fit: contain; }

    .card-info { flex: 1; min-width: 0; }
    .card-info h3 { margin: 0; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-info p { margin: 4px 0 0; font-size: 13px; color: var(--text-muted); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    .card-actions {
      position: absolute;
      top: 10px; right: 10px;
      display: flex; gap: 5px; opacity: 0;
    }
    .card:hover .card-actions { opacity: 1; }
    .icon-btn {
      background: rgba(0,0,0,0.3);
      border: none; color: white;
      width: 28px; height: 28px; border-radius: 6px;
      cursor: pointer; display: grid; place-items: center;
    }
    .icon-btn:hover { background: var(--accent); }

    dialog {
      background: var(--panel);
      color: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 30px;
      width: 90%;
      max-width: 500px;
      backdrop-filter: blur(25px);
      box-shadow: 0 0 40px rgba(0,0,0,0.5);
    }
    dialog::backdrop { background: rgba(0,0,0,0.8); }
    .form-group { margin-bottom: 20px; position: relative; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-muted); }
    input, select, textarea {
      width: 100%;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      color: white;
      outline: none;
    }
    input:focus, textarea:focus { border-color: var(--accent); }

    .ai-loading {
        display: none;
        font-size: 12px;
        color: var(--ai-accent);
        margin-top: 5px;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      padding: 12px 24px;
      border-radius: 99px;
      font-size: 14px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
    }

    .ai-btn-inline {
        position: absolute;
        right: 10px;
        top: 35px;
        background: var(--ai-accent);
        border: none;
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        cursor: pointer;
    }

    @media (max-width: 600px) {
      header { flex-direction: column; align-items: stretch; }
      .search-bar { max-width: none; }
    }
  </style>
</head>
<body>

  <div id="lock-screen" style="display: none;">
    <div class="lock-box">
      <h2>ğŸ” ç§äººç©ºé—´</h2>
      <p style="color: var(--text-muted); margin-bottom: 20px;">è¯·è¾“å…¥è®¿é—®å¯†ç </p>
      <input type="password" id="unlock-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" style="text-align: center; font-size: 24px; letter-spacing: 4px;">
      <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="checkUnlock()">è¿›å…¥ç½‘ç«™</button>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="brand">
        <h1>ç§äººå¯¼èˆªé—¨æˆ·</h1>
      </div>
      <div class="search-bar">
        <span>ğŸ”</span>
        <input type="text" id="search-input" placeholder="æœç´¢ä¹¦ç­¾æˆ–åˆ†ç±»...">
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="openSiteModal()">+ ç½‘ç«™</button>
        <button class="btn" onclick="openCatModal()">+ åˆ†ç±»</button>
        <button class="btn btn-ai" id="ai-tidy-btn" onclick="aiSmartTidy()">âœ¨ AI æ•´ç†</button>
        <button class="btn" onclick="aiRecommendation()">âœ¨ AI æ¨è</button>
        <button class="btn" onclick="exportData()">ğŸ’¾ å¯¼å‡º</button>
        <button class="btn" onclick="document.getElementById('file-input').click()">ğŸ“‚ å¯¼å…¥</button>
        <button class="btn" onclick="toggleSettings()">âš™ï¸ è®¾ç½®</button>
      </div>
    </header>

    <div id="main-content"></div>
  </div>

  <input type="file" id="file-input" style="display: none;" onchange="importData(event)">

  <dialog id="site-dialog">
    <h2 id="modal-title">æ·»åŠ ä¹¦ç­¾</h2>
    <form id="site-form" method="dialog">
      <input type="hidden" id="edit-id">
      <div class="form-group">
        <label>åç§°</label>
        <input type="text" id="site-name" required placeholder="ä¾‹å¦‚: GitHub">
      </div>
      <div class="form-group">
        <label>é“¾æ¥ (URL)</label>
        <input type="url" id="site-url" required placeholder="https://...">
      </div>
      <div class="form-group">
        <label>åˆ†ç±»</label>
        <select id="site-cat"></select>
      </div>
      <div class="form-group">
        <label>æè¿°</label>
        <button type="button" class="ai-btn-inline" onclick="generateAiDescription()">âœ¨ è‡ªåŠ¨ç”Ÿæˆ</button>
        <textarea id="site-desc" rows="3"></textarea>
        <div id="ai-desc-loader" class="ai-loading">AI æ­£åœ¨æ’°å†™æè¿°...</div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button type="button" class="btn" onclick="this.closest('dialog').close()">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </form>
  </dialog>

  <dialog id="cat-dialog">
    <h2>ç®¡ç†åˆ†ç±»</h2>
    <form id="cat-form" method="dialog">
      <input type="hidden" id="cat-edit-id">
      <div class="form-group">
        <label>åˆ†ç±»åç§°</label>
        <input type="text" id="cat-name" required>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button type="button" class="btn" onclick="this.closest('dialog').close()">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">ç¡®å®š</button>
      </div>
    </form>
  </dialog>

  <dialog id="settings-dialog">
    <h2>å…¨å±€è®¾ç½®</h2>
    <div class="form-group">
      <label>è®¾ç½®è®¿é—®å¯†ç  (ç•™ç©ºåˆ™ä¸å¯ç”¨)</label>
      <input type="password" id="set-password" placeholder="è®¾ç½®æ–°å¯†ç ">
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button type="button" class="btn" onclick="saveSettings()">ä¿å­˜å¹¶å…³é—­</button>
    </div>
  </dialog>

  <div id="toast" class="toast"></div>

  <script>
    const STORAGE_KEY = 'private_nav_data_ai';
    const SETTINGS_KEY = 'private_nav_settings_ai';
    const apiKey = ""; // æ‰§è¡Œç¯å¢ƒå°†æä¾›æ­¤å¯†é’¥

    let state = {
      categories: [{id: '1', name: 'å¸¸ç”¨'}, {id: '2', name: 'å­¦ä¹ '}, {id: '3', name: 'å¨±ä¹'}],
      sites: []
    };

    let settings = { password: '' };

    // --- Gemini API å°è£… ---
    async function callGemini(prompt, systemInstruction = "ä½ æ˜¯ä¸€ä¸ªç½‘é¡µæ”¶è—åŠ©æ‰‹ã€‚") {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      };

      for (let i = 0; i < 5; i++) {
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) throw new Error('API Error');
          const data = await response.json();
          return data.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch (e) {
          const delay = Math.pow(2, i) * 1000;
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
      throw new Error('AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•');
    }

    // --- AI åŠŸèƒ½å®ç° ---

    async function generateAiDescription() {
      const name = document.getElementById('site-name').value;
      const url = document.getElementById('site-url').value;
      const loader = document.getElementById('ai-desc-loader');
      const textarea = document.getElementById('site-desc');

      if (!name && !url) {
        showToast("è¯·è‡³å°‘å¡«å†™åç§°æˆ–ç½‘å€");
        return;
      }

      loader.style.display = 'block';
      try {
        const prompt = `è¯·ä¸ºè¿™ä¸ªç½‘ç«™å†™ä¸€æ®µç®€çŸ­çš„ä¸­æ–‡æè¿°ï¼ˆ20-40å­—ï¼‰ï¼šåç§°ï¼š${name}ï¼Œç½‘å€ï¼š${url}ã€‚ç›´æ¥è¾“å‡ºæè¿°ï¼Œä¸è¦åŠ å¼•å·ã€‚`;
        const result = await callGemini(prompt);
        textarea.value = result.trim();
        showToast("æè¿°å·²ç”Ÿæˆ");
      } catch (e) {
        showToast(e.message);
      } finally {
        loader.style.display = 'none';
      }
    }

    async function aiSmartTidy() {
        if (state.sites.length === 0) {
            showToast("è¿˜æ²¡æœ‰ä¹¦ç­¾å¯ä»¥æ•´ç†å“¦");
            return;
        }

        showToast("AI æ­£åœ¨åˆ†ææ‚¨çš„ä¹¦ç­¾...");
        try {
            const categoriesInfo = state.categories.map(c => `${c.id}:${c.name}`).join(', ');
            const sitesInfo = state.sites.map(s => `ID:${s.id}|å:${s.name}|URL:${s.url}`).join('\n');
            
            const prompt = `ç°æœ‰åˆ†ç±»ï¼š[${categoriesInfo}]ã€‚
            ä¹¦ç­¾åˆ—è¡¨ï¼š
            ${sitesInfo}
            
            è¯·å°†ä¹¦ç­¾å½’ç±»åˆ°æœ€åˆé€‚çš„ç°æœ‰åˆ†ç±»ä¸­ã€‚
            æŒ‰æ­¤JSONæ ¼å¼è¿”å›ï¼š{"assignments": [{"siteId": "xxx", "catId": "xxx"}]}`;
            
            const resultText = await callGemini(prompt, "ä½ æ˜¯ä¸€ä¸ªæ•°æ®åˆ†ç±»ä¸“å®¶ï¼Œåªè¿”å›JSONã€‚");
            const cleanJson = resultText.replace(/```json|```/g, '').trim();
            const data = JSON.parse(cleanJson);
            
            data.assignments.forEach(task => {
                const site = state.sites.find(s => s.id === task.siteId);
                if (site) site.catId = task.catId;
            });
            
            save();
            showToast("âœ¨ AI å·²ä¸ºæ‚¨æ•´ç†å®Œæ¯•");
        } catch (e) {
            showToast("æ™ºèƒ½æ•´ç†å¤±è´¥: " + e.message);
        }
    }

    async function aiRecommendation() {
        showToast("AI æ­£åœ¨æ ¹æ®æ‚¨çš„æ”¶è—ä¸ºæ‚¨æœç´¢æ¨è...");
        try {
            const currentSites = state.sites.slice(-5).map(s => s.name).join(', ');
            const prompt = `æˆ‘æœ€è¿‘æ”¶è—äº†è¿™äº›ç½‘ç«™ï¼š${currentSites}ã€‚è¯·æ¨è3ä¸ªæˆ‘å¯èƒ½æ„Ÿå…´è¶£çš„å…¶ä»–ç½‘ç«™ã€‚
            è¾“å‡ºæ ¼å¼ï¼šç½‘ç«™åç§° - ç®€çŸ­æ¨èè¯­ - URL`;
            
            const result = await callGemini(prompt, "ä½ æ˜¯ä¸€ä¸ªç½‘é¡µå‘ç°ä¸“å®¶ã€‚ä½¿ç”¨Googleæœç´¢è·å–æœ€æ–°ä¿¡æ¯ã€‚");
            alert("âœ¨ AI ä¸ºæ‚¨æ¨èï¼š\n\n" + result);
        } catch (e) {
            showToast("è·å–æ¨èå¤±è´¥");
        }
    }

    // --- æ ¸å¿ƒé€»è¾‘ (ä¿æŒåŸæœ‰é€»è¾‘å¹¶ç•¥ä½œè°ƒæ•´) ---

    function init() {
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (savedData) state = JSON.parse(savedData);
      const savedSettings = localStorage.getItem(SETTINGS_KEY);
      if (savedSettings) settings = JSON.parse(savedSettings);

      if (settings.password) {
        document.getElementById('lock-screen').style.display = 'flex';
      }
      render();
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      render();
    }

    function render() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const container = document.getElementById('main-content');
      container.innerHTML = '';

      state.categories.forEach(cat => {
        const catSites = state.sites.filter(s => s.catId === cat.id && 
          (s.name.toLowerCase().includes(searchTerm) || s.url.toLowerCase().includes(searchTerm)));

        if (catSites.length === 0 && searchTerm) return;

        const section = document.createElement('div');
        section.className = 'category-section';
        section.innerHTML = `
          <div class="category-header">
            <h2>${cat.name}</h2>
            <span style="font-size:12px; color:var(--text-muted)">${catSites.length}</span>
            <button class="icon-btn" onclick="deleteCat('${cat.id}')" style="margin-left:auto; opacity:0.3">ğŸ—‘</button>
          </div>
          <div class="grid" id="grid-${cat.id}"></div>
        `;
        
        container.appendChild(section);
        const grid = document.getElementById(`grid-${cat.id}`);

        catSites.forEach(site => {
          let hostname = "unknown";
          try { hostname = new URL(site.url).hostname; } catch(e) {}
          const faviconUrl = `https://www.google.com/s2/favicons?domain=${hostname}&sz=64`;
          
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="card-actions">
              <button class="icon-btn" onclick="event.preventDefault(); editSite('${site.id}')">âœ</button>
              <button class="icon-btn" onclick="event.preventDefault(); deleteSite('${site.id}')">ğŸ—‘</button>
            </div>
            <div class="card-top">
              <div class="favicon"><img src="${faviconUrl}" onerror="this.src='https://ui-avatars.com/api/?name=${site.name}'"></div>
              <div class="card-info">
                <h3>${site.name}</h3>
                <p title="${site.url}">${hostname}</p>
              </div>
            </div>
            ${site.desc ? `<p style="font-size:12px; color:var(--text-muted); margin:0; line-height:1.4">${site.desc}</p>` : ''}
            <a href="${site.url}" target="_blank" style="position:absolute; inset:0; z-index:1"></a>
          `;
          grid.appendChild(card);
        });
      });
    }

    // äº‹ä»¶ç›‘å¬ä¸å¸¸ç”¨å‡½æ•°
    function checkUnlock() {
      const input = document.getElementById('unlock-pass').value;
      if (input === settings.password) {
        document.getElementById('lock-screen').style.opacity = '0';
        setTimeout(() => document.getElementById('lock-screen').style.display = 'none', 300);
      } else { showToast('å¯†ç é”™è¯¯'); }
    }

    function openSiteModal(siteId = null) {
      const dialog = document.getElementById('site-dialog');
      const catSelect = document.getElementById('site-cat');
      catSelect.innerHTML = state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      
      if (siteId) {
        const site = state.sites.find(s => s.id === siteId);
        document.getElementById('edit-id').value = site.id;
        document.getElementById('site-name').value = site.name;
        document.getElementById('site-url').value = site.url;
        document.getElementById('site-cat').value = site.catId;
        document.getElementById('site-desc').value = site.desc || '';
        document.getElementById('modal-title').textContent = 'ç¼–è¾‘ä¹¦ç­¾';
      } else {
        document.getElementById('site-form').reset();
        document.getElementById('edit-id').value = '';
        document.getElementById('modal-title').textContent = 'æ·»åŠ ä¹¦ç­¾';
      }
      dialog.showModal();
    }

    document.getElementById('site-form').onsubmit = function() {
      const id = document.getElementById('edit-id').value;
      const site = {
        id: id || Date.now().toString(),
        name: document.getElementById('site-name').value,
        url: document.getElementById('site-url').value,
        catId: document.getElementById('site-cat').value,
        desc: document.getElementById('site-desc').value
      };
      if (id) {
        const idx = state.sites.findIndex(s => s.id === id);
        state.sites[idx] = site;
      } else { state.sites.push(site); }
      save();
    };

    function deleteSite(id) {
      if (confirm('åˆ é™¤è¯¥ä¹¦ç­¾ï¼Ÿ')) { state.sites = state.sites.filter(s => s.id !== id); save(); }
    }

    function editSite(id) { openSiteModal(id); }

    function openCatModal() { document.getElementById('cat-dialog').showModal(); }
    document.getElementById('cat-form').onsubmit = function() {
      state.categories.push({ id: Date.now().toString(), name: document.getElementById('cat-name').value });
      save();
    };

    function deleteCat(id) {
      if (state.sites.some(s => s.catId === id)) return alert('è¯·å…ˆæ¸…ç©ºæ­¤åˆ†ç±»ä¸‹çš„ä¹¦ç­¾');
      if (confirm('åˆ é™¤åˆ†ç±»ï¼Ÿ')) { state.categories = state.categories.filter(c => c.id !== id); save(); }
    }

    function toggleSettings() {
      document.getElementById('set-password').value = settings.password;
      document.getElementById('settings-dialog').showModal();
    }

    function saveSettings() {
      settings.password = document.getElementById('set-password').value;
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      document.getElementById('settings-dialog').close();
      showToast('è®¾ç½®å·²ä¿å­˜');
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `bookmarks_ai_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    }

    async function importData(e) {
      const file = e.target.files[0];
      if (!file) return;
      try {
        state = JSON.parse(await file.text());
        save();
        showToast('å¯¼å…¥æˆåŠŸ');
      } catch (err) { showToast('å¯¼å…¥å¤±è´¥'); }
    }

    document.getElementById('search-input').oninput = render;

    init();
  </script>
</body>
</html>

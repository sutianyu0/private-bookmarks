<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç§äººå¯¼èˆªé—¨æˆ· | AI Agent Dashboard</title>
  <style>
    :root {
      --bg: #050810;
      --panel: rgba(17, 25, 40, 0.75);
      --card: rgba(25, 35, 55, 0.6);
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.5);
      --ai-accent: #8b5cf6;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
      --radius-lg: 20px;
      --radius-md: 12px;
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; transition: all 0.2s ease; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* å¸ƒå±€å®¹å™¨ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      width: 100%;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .brand h1 {
      margin: 0;
      font-size: 24px;
      background: linear-gradient(to right, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .search-bar {
      display: flex;
      align-items: center;
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 99px;
      width: 100%;
      max-width: 400px;
    }
    .search-bar input {
      background: transparent;
      border: none;
      color: white;
      padding: 8px;
      width: 100%;
      outline: none;
    }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      background: var(--panel);
      border: 1px solid var(--border);
      color: white;
      padding: 10px 18px;
      border-radius: 99px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn:hover { background: var(--border); transform: translateY(-2px); }
    .btn-primary { background: var(--accent); border-color: var(--accent); }
    .btn-ai { background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; }

    /* ä¾§è¾¹ AI åŠ©æ‰‹ */
    #ai-assistant-toggle {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 30px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.5);
        display: grid;
        place-items: center;
        cursor: pointer;
        z-index: 1000;
        font-size: 24px;
    }
    #ai-assistant-toggle:hover { transform: scale(1.1) rotate(5deg); }

    #ai-drawer {
        position: fixed;
        top: 0;
        right: -400px;
        width: 380px;
        height: 100vh;
        background: rgba(10, 15, 30, 0.95);
        backdrop-filter: blur(25px);
        border-left: 1px solid var(--border);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #ai-drawer.open { right: 0; }

    .ai-header { padding: 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .ai-chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .ai-msg { padding: 12px 16px; border-radius: 14px; font-size: 14px; line-height: 1.5; max-width: 85%; }
    .ai-msg.user { background: var(--border); align-self: flex-end; }
    .ai-msg.bot { background: var(--panel); border: 1px solid var(--border); align-self: flex-start; }

    .ai-preview-box {
        margin-top: 10px;
        background: rgba(139, 92, 246, 0.1);
        border: 1px dashed var(--ai-accent);
        border-radius: 12px;
        padding: 12px;
    }
    .ai-preview-item { font-size: 12px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }

    .ai-input-area { padding: 20px; border-top: 1px solid var(--border); }
    .ai-input-wrapper { display: flex; gap: 10px; }
    #ai-text-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 12px; color: white; resize: none; }

    /* ç½‘æ ¼ä¸å¡ç‰‡ */
    .category-section { margin-bottom: 40px; }
    .category-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; position: relative; text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 12px; backdrop-filter: blur(10px); }
    .card:hover { border-color: var(--accent); transform: translateY(-5px); }

    .favicon { width: 32px; height: 32px; border-radius: 8px; background: var(--bg); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .favicon img { width: 100%; height: 100%; object-fit: contain; }

    /* é€šç”¨å¼¹çª— */
    dialog { background: var(--panel); color: white; border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 30px; width: 90%; max-width: 500px; backdrop-filter: blur(25px); }
    dialog::backdrop { background: rgba(0,0,0,0.8); }
    .form-group { margin-bottom: 20px; }
    input, select, textarea { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: white; outline: none; }

    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--accent); padding: 12px 24px; border-radius: 99px; font-size: 14px; z-index: 10000; display: none; }

    @keyframes spin { from {transform: rotate(0deg)} to {transform: rotate(360deg)} }
    .loading-icon { animation: spin 1s linear infinite; }
  </style>
</head>
<body>

  <!-- è®¿é—®é” -->
  <div id="lock-screen" style="display: none;">
    <div class="lock-box">
      <h2>ğŸ” ç§äººç©ºé—´</h2>
      <input type="password" id="unlock-pass" placeholder="è¯·è¾“å…¥å¯†ç " style="text-align: center; font-size: 24px;">
      <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="checkUnlock()">è¿›å…¥ç½‘ç«™</button>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="brand"><h1>ç§äººå¯¼èˆªé—¨æˆ·</h1></div>
      <div class="search-bar">
        <span>ğŸ”</span>
        <input type="text" id="search-input" placeholder="æœç´¢ä¹¦ç­¾æˆ–åˆ†ç±»...">
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="openSiteModal()">+ ç½‘ç«™</button>
        <button class="btn" onclick="openCatModal()">+ åˆ†ç±»</button>
        <button class="btn" onclick="exportData()">ğŸ’¾ å¯¼å‡º</button>
        <button class="btn" onclick="document.getElementById('file-input').click()">ğŸ“‚ å¯¼å…¥</button>
      </div>
    </header>

    <div id="main-content"></div>
  </div>

  <!-- AI ä¾§è¾¹åŠ©æ‰‹ -->
  <div id="ai-assistant-toggle" onclick="toggleAiDrawer()">ğŸ¤–</div>
  <div id="ai-drawer">
    <div class="ai-header">
      <h3 style="margin:0">âœ¨ AI åŠ©æ‰‹</h3>
      <button class="icon-btn" onclick="toggleAiDrawer()">âœ•</button>
    </div>
    <div class="ai-chat" id="ai-chat-history">
      <div class="ai-msg bot">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ç§äººä¹¦ç­¾ç®¡å®¶ã€‚ä½ å¯ä»¥è·Ÿæˆ‘è¯´ï¼š<br>â€œå¸®æˆ‘å»ºä¸€ä¸ªâ€˜è®¾è®¡â€™åˆ†ç±»ï¼Œé‡Œé¢åŠ ä¸Š Pinterest å’Œ Dribbbleã€‚â€<br>æˆ‘ä¼šå…ˆä¸ºä½ å‡†å¤‡å¥½é¢„è§ˆï¼Œç¡®è®¤åå†æ‰§è¡Œã€‚</div>
    </div>
    <div id="ai-pending-plan" style="padding: 0 20px; display:none;">
        <div class="ai-preview-box">
            <strong style="font-size: 13px; color: var(--ai-accent);">ğŸ“‹ å¾…ç¡®è®¤æ“ä½œæ¸…å•ï¼š</strong>
            <div id="plan-details" style="margin: 10px 0;"></div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="applyAiPlan()">ç¡®è®¤æ‰§è¡Œ</button>
                <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="discardAiPlan()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <div class="ai-input-area">
      <div class="ai-input-wrapper">
        <textarea id="ai-text-input" rows="2" placeholder="è¾“å…¥æŒ‡ä»¤..."></textarea>
        <button class="btn btn-ai" id="ai-send-btn" onclick="handleAiCommand()">å‘é€</button>
      </div>
    </div>
  </div>

  <!-- å¼¹çª—ç»„ä»¶ -->
  <dialog id="site-dialog">
    <h2 id="modal-title">æ·»åŠ ä¹¦ç­¾</h2>
    <form id="site-form" method="dialog">
      <input type="hidden" id="edit-id">
      <div class="form-group"><input type="text" id="site-name" required placeholder="ç½‘ç«™å"></div>
      <div class="form-group"><input type="url" id="site-url" required placeholder="https://..."></div>
      <div class="form-group"><select id="site-cat"></select></div>
      <div class="form-group"><textarea id="site-desc" rows="2" placeholder="æè¿°"></textarea></div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button type="button" class="btn" onclick="this.closest('dialog').close()">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </form>
  </dialog>

  <dialog id="cat-dialog">
    <h2>ç®¡ç†åˆ†ç±»</h2>
    <form id="cat-form" method="dialog">
      <div class="form-group"><input type="text" id="cat-name" required placeholder="åˆ†ç±»å"></div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button type="button" class="btn" onclick="this.closest('dialog').close()">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">ç¡®å®š</button>
      </div>
    </form>
  </dialog>

  <input type="file" id="file-input" style="display: none;" onchange="importData(event)">
  <div id="toast" class="toast"></div>

  <script>
    const STORAGE_KEY = 'private_nav_data_v2';
    const apiKey = ""; 

    let state = {
      categories: [{id: '1', name: 'å¸¸ç”¨'}],
      sites: []
    };
    let pendingPlan = null;

    // --- Gemini API ---
    async function callGemini(prompt, systemInstruction) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      };
      for (let i = 0; i < 5; i++) {
        try {
          const resp = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
          if (!resp.ok) throw new Error();
          const data = await resp.json();
          return data.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch (e) { await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000)); }
      }
      throw new Error('AI è¿æ¥å¤±è´¥');
    }

    // --- AI æŒ‡ä»¤é€»è¾‘ ---
    async function handleAiCommand() {
        const inputEl = document.getElementById('ai-text-input');
        const text = inputEl.value.trim();
        if (!text) return;

        addChatMessage('user', text);
        inputEl.value = '';
        document.getElementById('ai-send-btn').disabled = true;
        document.getElementById('ai-send-btn').innerHTML = '<span class="loading-icon">â³</span>';

        const sysPrompt = `ä½ æ˜¯ä¸€ä¸ªç§äººä¹¦ç­¾ç®¡å®¶åŠ©æ‰‹ã€‚ç”¨æˆ·çš„å½“å‰åˆ†ç±»æœ‰ï¼š${state.categories.map(c => c.name).join(', ')}ã€‚
        ä½ çš„ä»»åŠ¡æ˜¯ç†è§£ç”¨æˆ·çš„æ“ä½œè¯·æ±‚ï¼ˆåˆ›å»ºåˆ†ç±»ã€æ·»åŠ ä¹¦ç­¾ï¼‰ã€‚
        ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ï¼Œä¸è¦åŒ…å«ä»»ä½•å¤šä½™æ–‡å­—ï¼š
        {
          "reply": "å¯¹ç”¨æˆ·è¯´çš„è¯",
          "actions": [
            {"type": "create_category", "name": "åˆ†ç±»å"},
            {"type": "add_site", "name": "ç½‘ç«™å", "url": "ç½‘å€", "category": "åˆ†ç±»å", "desc": "å¯é€‰æè¿°"}
          ]
        }`;

        try {
            const responseText = await callGemini(text, sysPrompt);
            const cleanJson = responseText.replace(/```json|```/g, '').trim();
            const result = JSON.parse(cleanJson);
            
            addChatMessage('bot', result.reply);
            if (result.actions && result.actions.length > 0) {
                showPlanPreview(result.actions);
            }
        } catch (e) {
            addChatMessage('bot', "æŠ±æ­‰ï¼Œæˆ‘æ²¡èƒ½ç†è§£è¿™ä¸ªæŒ‡ä»¤æˆ–å‘ç”Ÿäº†é”™è¯¯ã€‚");
        } finally {
            document.getElementById('ai-send-btn').disabled = false;
            document.getElementById('ai-send-btn').innerText = 'å‘é€';
        }
    }

    function showPlanPreview(actions) {
        pendingPlan = actions;
        const planBox = document.getElementById('ai-pending-plan');
        const details = document.getElementById('plan-details');
        details.innerHTML = actions.map(a => {
            if (a.type === 'create_category') return `<div class="ai-preview-item">ğŸ“ æ–°å»ºåˆ†ç±»: <b>${a.name}</b></div>`;
            if (a.type === 'add_site') return `<div class="ai-preview-item">ğŸ”— æ·»åŠ ä¹¦ç­¾: <b>${a.name}</b> (${a.category})</div>`;
            return '';
        }).join('');
        planBox.style.display = 'block';
        document.getElementById('ai-chat-history').scrollTop = document.getElementById('ai-chat-history').scrollHeight;
    }

    function applyAiPlan() {
        if (!pendingPlan) return;
        
        pendingPlan.forEach(action => {
            if (action.type === 'create_category') {
                if (!state.categories.find(c => c.name === action.name)) {
                    state.categories.push({ id: Date.now().toString() + Math.random(), name: action.name });
                }
            } else if (action.type === 'add_site') {
                let cat = state.categories.find(c => c.name === action.category);
                if (!cat) {
                    cat = { id: Date.now().toString() + Math.random(), name: action.category };
                    state.categories.push(cat);
                }
                state.sites.push({
                    id: Date.now().toString() + Math.random(),
                    name: action.name,
                    url: action.url.startsWith('http') ? action.url : 'https://' + action.url,
                    catId: cat.id,
                    desc: action.desc || ""
                });
            }
        });

        save();
        discardAiPlan();
        showToast("âœ¨ æŒ‡ä»¤æ‰§è¡ŒæˆåŠŸï¼");
    }

    function discardAiPlan() {
        pendingPlan = null;
        document.getElementById('ai-pending-plan').style.display = 'none';
    }

    function addChatMessage(role, text) {
        const history = document.getElementById('ai-chat-history');
        const msg = document.createElement('div');
        msg.className = `ai-msg ${role}`;
        msg.innerHTML = text.replace(/\n/g, '<br>');
        history.appendChild(msg);
        history.scrollTop = history.scrollHeight;
    }

    function toggleAiDrawer() {
        document.getElementById('ai-drawer').classList.toggle('open');
    }

    // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---
    function init() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) state = JSON.parse(data);
      render();
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      render();
    }

    function render() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const container = document.getElementById('main-content');
      container.innerHTML = '';

      state.categories.forEach(cat => {
        const catSites = state.sites.filter(s => s.catId === cat.id && 
          (s.name.toLowerCase().includes(searchTerm) || s.url.toLowerCase().includes(searchTerm)));

        if (catSites.length === 0 && searchTerm) return;

        const section = document.createElement('div');
        section.className = 'category-section';
        section.innerHTML = `
          <div class="category-header">
            <h2>${cat.name}</h2>
            <button class="icon-btn" onclick="deleteCat('${cat.id}')" style="margin-left:auto; opacity:0.3">ğŸ—‘</button>
          </div>
          <div class="grid" id="grid-${cat.id}"></div>
        `;
        container.appendChild(section);
        const grid = document.getElementById(`grid-${cat.id}`);

        catSites.forEach(site => {
          let hostname = "link";
          try { hostname = new URL(site.url).hostname; } catch(e) {}
          const faviconUrl = `https://www.google.com/s2/favicons?domain=${hostname}&sz=64`;
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="card-actions">
              <button class="icon-btn" onclick="event.preventDefault(); editSite('${site.id}')">âœ</button>
              <button class="icon-btn" onclick="event.preventDefault(); deleteSite('${site.id}')">ğŸ—‘</button>
            </div>
            <div class="card-top">
              <div class="favicon"><img src="${faviconUrl}" onerror="this.src='https://ui-avatars.com/api/?name=${site.name}'"></div>
              <div class="card-info">
                <h3>${site.name}</h3>
                <p>${hostname}</p>
              </div>
            </div>
            ${site.desc ? `<p style="font-size:12px; color:var(--text-muted); margin:0;">${site.desc}</p>` : ''}
            <a href="${site.url}" target="_blank" style="position:absolute; inset:0; z-index:1"></a>
          `;
          grid.appendChild(card);
        });
      });
    }

    // --- å¼¹çª—ä¸åŸºç¡€æ“ä½œ ---
    function openSiteModal(siteId = null) {
      const dialog = document.getElementById('site-dialog');
      const catSelect = document.getElementById('site-cat');
      catSelect.innerHTML = state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      if (siteId) {
        const s = state.sites.find(x => x.id === siteId);
        document.getElementById('edit-id').value = s.id;
        document.getElementById('site-name').value = s.name;
        document.getElementById('site-url').value = s.url;
        document.getElementById('site-cat').value = s.catId;
        document.getElementById('site-desc').value = s.desc || '';
      } else { document.getElementById('site-form').reset(); document.getElementById('edit-id').value = ''; }
      dialog.showModal();
    }

    document.getElementById('site-form').onsubmit = function() {
      const id = document.getElementById('edit-id').value;
      const site = {
        id: id || Date.now().toString(),
        name: document.getElementById('site-name').value,
        url: document.getElementById('site-url').value,
        catId: document.getElementById('site-cat').value,
        desc: document.getElementById('site-desc').value
      };
      if (id) { const idx = state.sites.findIndex(s => s.id === id); state.sites[idx] = site; }
      else { state.sites.push(site); }
      save();
    };

    function openCatModal() { document.getElementById('cat-dialog').showModal(); }
    document.getElementById('cat-form').onsubmit = function() {
      state.categories.push({ id: Date.now().toString(), name: document.getElementById('cat-name').value });
      save();
    };

    function deleteSite(id) { if (confirm('åˆ é™¤ä¹¦ç­¾ï¼Ÿ')) { state.sites = state.sites.filter(s => s.id !== id); save(); } }
    function editSite(id) { openSiteModal(id); }
    function deleteCat(id) { if (confirm('åˆ é™¤åˆ†ç±»ï¼Ÿ')) { state.categories = state.categories.filter(c => c.id !== id); save(); } }
    function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); }
    function exportData() {
      const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'bookmarks_agent.json'; a.click();
    }
    async function importData(e) {
      try { state = JSON.parse(await e.target.files[0].text()); save(); showToast('å¯¼å…¥æˆåŠŸ'); } catch (err) { showToast('æ ¼å¼é”™è¯¯'); }
    }

    document.getElementById('search-input').oninput = render;
    init();
  </script>
</body>
</html>

<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„ç§äººä¹¦ç­¾é¡µ</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111b2e;
      --muted:#92a3c6;
      --text:#eaf0ff;
      --line:#223255;
      --accent:#6aa6ff;
      --accent2:#7cffc4;
      --danger:#ff6a6a;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
      --gap:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(106,166,255,.18), transparent 50%),
                  radial-gradient(900px 500px at 80% 10%, rgba(124,255,196,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1150px; margin:0 auto; padding:28px 18px 60px}
    header{
      display:flex; gap:16px; align-items:flex-start; justify-content:space-between;
      margin-bottom:18px;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    .title h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .title p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end;
    }

    .search{
      display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px;
      padding:10px 12px;
      min-width:280px;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .search input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      padding:4px 8px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      user-select:none;
      cursor:pointer;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      transition:transform .04s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.18);}
    .btn:active{ transform:scale(.98);}
    .btn.primary{
      background:linear-gradient(135deg, rgba(106,166,255,.35), rgba(124,255,196,.25));
      border-color:rgba(106,166,255,.35);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    .btn.danger{
      background:rgba(255,106,106,.12);
      border-color:rgba(255,106,106,.25);
      color:#ffd7d7;
    }

    .stats{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:10px 0 18px;
      color:var(--muted);
      font-size:12px;
    }
    .stats code{
      font-family:var(--mono);
      color:#cfe0ff;
      background:rgba(255,255,255,.04);
      padding:2px 6px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:8px;
    }

    .grid{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .cat{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cat-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      gap:12px;
    }
    .cat-left{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .caret{
      width:28px; height:28px; border-radius:10px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .caret span{
      display:inline-block;
      transform:rotate(0deg);
      transition:transform .18s ease;
    }
    .cat.collapsed .caret span{ transform:rotate(-90deg); }

    .cat-name{
      display:flex; flex-direction:column; gap:2px; min-width:0;
    }
    .cat-name strong{
      font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .cat-name small{
      color:var(--muted);
      font-size:12px;
    }

    .cat-actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }

    .sites{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap:12px;
    }
    .cat.collapsed .sites{ display:none; }

    .card{
      background:rgba(17,27,46,.75);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px;
      transition:transform .08s ease, border-color .15s ease, background .15s ease;
      position:relative;
      overflow:hidden;
    }
    .card:hover{
      transform:translateY(-1px);
      border-color:rgba(106,166,255,.35);
      background:rgba(17,27,46,.92);
    }
    .card .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card h3{
      margin:0;
      font-size:14px;
      line-height:1.25;
    }
    .card p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      min-height:32px;
    }
    .url{
      margin-top:10px;
      font-family:var(--mono);
      font-size:11px;
      color:#bcd1ff;
      opacity:.9;
      word-break:break-all;
      padding:8px 9px;
      border-radius:10px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.07);
    }

    .mini-actions{
      display:flex; gap:6px; flex-shrink:0;
    }
    .iconbtn{
      width:30px; height:30px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      display:grid; place-items:center;
      color:var(--muted);
    }
    .iconbtn:hover{ color:var(--text); border-color:rgba(255,255,255,.18); background:rgba(255,255,255,.06); }
    .iconbtn.danger{ border-color:rgba(255,106,106,.25); color:#ffb9b9; background:rgba(255,106,106,.08); }

    /* åº•éƒ¨å¤§â€œè¿›å…¥ç½‘ç«™â€æŒ‰é’® */
    .openbig{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
      margin-top:10px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(106,166,255,.35);
      background:linear-gradient(135deg, rgba(106,166,255,.28), rgba(124,255,196,.18));
      color:var(--text);
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      user-select:none;
    }
    .openbig:hover{
      border-color:rgba(106,166,255,.55);
      background:linear-gradient(135deg, rgba(106,166,255,.34), rgba(124,255,196,.22));
    }
    .openbig:active{
      transform:scale(.99);
    }

    dialog{
      border:none;
      border-radius:18px;
      background:#0f1830;
      color:var(--text);
      width:min(560px, 92vw);
      box-shadow: 0 20px 55px rgba(0,0,0,.55);
      padding:0;
    }
    dialog::backdrop{ background:rgba(0,0,0,.55); }
    .modal{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .modal h2{ margin:0; font-size:14px; }
    .modal .close{
      width:34px; height:34px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      cursor:pointer; color:var(--muted);
      display:grid; place-items:center;
    }
    .modal .close:hover{ color:var(--text); }

    .form{
      padding:14px;
      display:grid;
      gap:10px;
    }
    label{ font-size:12px; color:var(--muted); display:block; margin:2px 0 6px; }
    input, textarea, select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{ min-height:70px; resize:vertical; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .foot{
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .hint{
      font-size:12px; color:var(--muted);
      padding:0 14px 10px;
      line-height:1.35;
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(15,24,48,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:10px 14px;
      color:var(--text);
      font-size:13px;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-3px); }

    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:2px 6px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:7px;
      background:rgba(255,255,255,.04);
      color:#cfe0ff;
    }

    @media (max-width:700px){
      header{ flex-direction:column; align-items:stretch; }
      .toolbar{ justify-content:stretch; }
      .search{ min-width:unset; width:100%; }
      .row{ grid-template-columns:1fr; }
    }
  
    /* --------- Assistant UI --------- */
    .fab{
      position:fixed; right:18px; bottom:18px;
      width:54px; height:54px; border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(135deg, rgba(106,166,255,.32), rgba(124,255,196,.20));
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      display:grid; place-items:center;
      cursor:pointer; user-select:none;
      z-index:50;
    }
    .fab:active{ transform:scale(.98); }
    .assistant{
      position:fixed; right:18px; bottom:84px;
      width:min(420px, calc(100vw - 36px));
      height:min(560px, calc(100vh - 120px));
      background:#0f1830;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      overflow:hidden;
      display:none;
      z-index:50;
    }
    .assistant.show{ display:flex; flex-direction:column; }
    .assistant-head{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .assistant-head strong{ font-size:13px; }
    .assistant-head small{ color:var(--muted); font-size:12px; }
    .assistant-body{
      padding:10px 12px;
      display:flex; flex-direction:column; gap:10px;
      overflow:auto;
      flex:1;
    }
    .msg{
      display:flex; gap:8px; align-items:flex-start;
    }
    .bubble{
      max-width:84%;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .msg.user{ justify-content:flex-end; }
    .msg.user .bubble{
      background:rgba(106,166,255,.14);
      border-color:rgba(106,166,255,.22);
    }
    .msg.assistant .bubble{
      background:rgba(124,255,196,.08);
      border-color:rgba(124,255,196,.18);
    }
    .assistant-foot{
      padding:10px 12px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:8px; align-items:flex-end;
    }
    .assistant-foot textarea{
      flex:1;
      min-height:44px; max-height:140px;
      resize:none;
      border-radius:14px;
    }
    .assistant-actions{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:0 12px 12px;
      border-top:1px dashed rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
    }
    .assistant-actions .btn{ padding:9px 11px; }
    .proposal-card{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .proposal-card strong{ color:var(--text); font-size:12px; }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>æˆ‘çš„ç§äººä¹¦ç­¾é¡µ</h1>
        <p>æœ¬åœ°å•æ–‡ä»¶ Â· ä»…ä½ å¯è§ Â· è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰ Â· æ”¯æŒæœç´¢ã€åˆ†ç±»ã€å¯¼å…¥/å¯¼å‡º</p>
      </div>

      <div class="toolbar">
        <div class="search" title="å¿«æ·é”®ï¼š/ èšç„¦æœç´¢ï¼ŒEsc æ¸…ç©º">
          <span style="color:var(--muted);font-family:var(--mono);font-size:12px;">/</span>
          <input id="q" placeholder="æœç´¢ï¼šç½‘ç«™å / æè¿° / URL / åˆ†ç±»" autocomplete="off" />
          <span class="pill" id="clearBtn">æ¸…ç©º</span>
        </div>
        <button class="btn primary" id="addSiteBtn">+ æ·»åŠ ç½‘ç«™</button>
        <button class="btn" id="addCatBtn">+ æ·»åŠ åˆ†ç±»</button>
        <button class="btn" id="exportBtn">å¯¼å‡º JSON</button>
        <button class="btn" id="importBtn">å¯¼å…¥ JSON</button>
        <button class="btn" id="ghSyncBtn">GitHub åŒæ­¥</button>
        <button class="btn" id="ghSettingsBtn">GitHub è®¾ç½®</button>
        <button class="btn danger" id="resetBtn">é‡ç½®</button>
      </div>
    </header>

    <div class="stats" id="stats"></div>
    <div class="grid" id="grid"></div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Modal: Add/Edit Site -->
  <dialog id="siteDialog">
    <div class="modal">
      <h2 id="siteDialogTitle">æ·»åŠ ç½‘ç«™</h2>
      <button class="close" id="closeSiteDialog" aria-label="close">âœ•</button>
    </div>
    <div class="hint">æç¤ºï¼šURL è®°å¾—å¸¦ https://ã€‚å¯ä»¥å†™æè¿°æ–¹ä¾¿æœç´¢ã€‚</div>
    <form class="form" id="siteForm" method="dialog">
      <input type="hidden" id="siteId" />
      <div class="row">
        <div>
          <label>ç½‘ç«™å</label>
          <input id="siteName" required placeholder="ä¾‹å¦‚ï¼šGitHub" />
        </div>
        <div>
          <label>åˆ†ç±»</label>
          <select id="siteCat"></select>
        </div>
      </div>
      <div>
        <label>URL</label>
        <input id="siteUrl" required placeholder="https://..." />
      </div>
      <div>
        <label>æè¿°ï¼ˆå¯é€‰ï¼‰</label>
        <textarea id="siteDesc" placeholder="ä¾‹å¦‚ï¼šä»£ç æ‰˜ç®¡ã€å¼€æºé¡¹ç›®"></textarea>
      </div>
      <div class="foot">
        <button class="btn" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" id="saveSiteBtn" value="default">ä¿å­˜</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Add/Edit Category -->
  <dialog id="catDialog">
    <div class="modal">
      <h2 id="catDialogTitle">æ·»åŠ åˆ†ç±»</h2>
      <button class="close" id="closeCatDialog" aria-label="close">âœ•</button>
    </div>
    <div class="hint">åˆ†ç±»ç”¨äºæ•´ç†ä¹¦ç­¾ã€‚ä½ å¯ä»¥éšæ—¶æ”¹åæˆ–åˆ é™¤ï¼ˆåˆ é™¤ä¼šä¸€èµ·åˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„ç½‘ç«™ï¼‰ã€‚</div>
    <form class="form" id="catForm" method="dialog">
      <input type="hidden" id="catId" />
      <div>
        <label>åˆ†ç±»å</label>
        <input id="catName" required placeholder="ä¾‹å¦‚ï¼šå­¦ä¹  / é‡‘è / å·¥å…·" />
      </div>
      <div class="foot">
        <button class="btn" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" id="saveCatBtn" value="default">ä¿å­˜</button>
      </div>
    </form>
  </dialog>


  <!-- Modal: GitHub Settings -->
  <dialog id="ghDialog">
    <div class="modal">
      <h2>GitHub åŒæ­¥è®¾ç½®</h2>
      <button class="close" id="closeGhDialog" aria-label="close">âœ•</button>
    </div>
    <div class="hint">
      è¯´æ˜ï¼šæ­¤é¡µé¢æ˜¯çº¯å‰ç«¯ç½‘é¡µï¼Œè‹¥è¦æŠŠæ•°æ®å†™å…¥ GitHubï¼Œéœ€è¦ä½ æä¾›ä¸€ä¸ª GitHub Personal Access Tokenï¼ˆPATï¼‰ã€‚
      ä¸ºå®‰å…¨èµ·è§ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸ä¿å­˜ tokenï¼ˆæ¯æ¬¡æ‰“å¼€ç½‘é¡µå†è¾“å…¥ä¸€æ¬¡ï¼‰ã€‚
    </div>
    <form class="form" id="ghForm" method="dialog">
      <div class="row">
        <div>
          <label>Ownerï¼ˆç”¨æˆ·åæˆ–ç»„ç»‡ï¼‰</label>
          <input id="ghOwner" placeholder="ä¾‹å¦‚ï¼štysu0506" />
        </div>
        <div>
          <label>Repoï¼ˆä»“åº“åï¼‰</label>
          <input id="ghRepo" placeholder="ä¾‹å¦‚ï¼šprivate-bookmarks" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Branchï¼ˆåˆ†æ”¯ï¼‰</label>
          <input id="ghBranch" placeholder="main" />
        </div>
        <div>
          <label>Pathï¼ˆJSON æ–‡ä»¶è·¯å¾„ï¼‰</label>
          <input id="ghPath" placeholder="data/bookmarks.json" />
        </div>
      </div>
      <div>
        <label>Tokenï¼ˆFine-grained PATï¼Œéœ€å¯¹è¯¥ä»“åº“ Contents è¯»å†™æƒé™ï¼‰</label>
        <input id="ghToken" type="password" placeholder="ghp_... æˆ– github_pat_..." />
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label style="margin:0; display:flex; gap:8px; align-items:center; cursor:pointer; color:var(--muted);">
          <input type="checkbox" id="ghRemember" style="width:auto; transform: translateY(1px);" />
          è®°ä½ tokenï¼ˆä¿å­˜åˆ°æœ¬æœº localStorageï¼Œä¸å»ºè®®åœ¨å…¬å…±ç”µè„‘å¼€å¯ï¼‰
        </label>
        <span style="color:var(--muted);font-size:12px;">å»ºè®®ï¼štoken ä¸ä¿å­˜æ—¶ä¼šå­˜åˆ° sessionStorageï¼ˆå…³æ‰æ ‡ç­¾é¡µå³æ¸…ç©ºï¼‰</span>
      </div>
      <div class="foot">
        <button class="btn" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" id="saveGhBtn" value="default">ä¿å­˜è®¾ç½®</button>
      </div>
    </form>
  </dialog>


  <!-- Hidden file input for import -->
  <input type="file" id="fileInput" accept="application/json" style="display:none"/>

  <!-- Assistant (Chat) UI -->
  <div class="fab" id="assistantFab" title="æ‰“å¼€åŠ©æ‰‹">ğŸ¤–</div>
  <div class="assistant" id="assistantPanel" aria-live="polite">
    <div class="assistant-head">
      <div style="display:flex;flex-direction:column;gap:2px;min-width:0">
        <strong>ä¹¦ç­¾åŠ©æ‰‹</strong>
        <small id="assistantSub">å…ˆæå‡ºæ–¹æ¡ˆï¼Œå†ç”±ä½ ç¡®è®¤æ‰§è¡Œ</small>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="iconbtn" id="assistantUndoBtn" title="æ’¤å›ä¸Šä¸€æ¬¡åº”ç”¨" style="width:34px;height:34px;border-radius:12px;">â†©</button>
        <button class="close" id="assistantClose" title="å…³é—­" style="width:34px;height:34px;border-radius:12px;">âœ•</button>
      </div>
    </div>
    <div class="assistant-body" id="assistantBody"></div>
    <div class="assistant-actions">
      <button class="btn" id="assistantReviewBtn" disabled>æŸ¥çœ‹å˜æ›´ææ¡ˆ</button>
      <button class="btn primary" id="assistantApplyBtn" disabled>ç¡®è®¤å¹¶åº”ç”¨</button>
      <button class="btn" id="assistantDiscardBtn" disabled>ä¸¢å¼ƒææ¡ˆ</button>
    </div>
    <div class="assistant-foot">
      <textarea id="assistantInput" placeholder="ä¾‹å¦‚ï¼šæŠŠè¿™ä¸‰ä¸ªå­¦æ ¡ portal å½’åˆ°â€œç ”ç©¶ç”Ÿç”³è¯· Portal(2026 Fall)â€å¹¶ç»™æ¯ä¸ªé“¾æ¥åŠ ä¸€å¥æè¿°"></textarea>
      <button class="btn primary" id="assistantSend">å‘é€</button>
    </div>
  </div>

  <!-- Modal: Proposal Review -->
  <dialog id="proposalDialog">
    <div class="modal">
      <h2>å˜æ›´ææ¡ˆï¼ˆéœ€è¦ä½ ç¡®è®¤ï¼‰</h2>
      <button class="close" id="closeProposalDialog" aria-label="close">âœ•</button>
    </div>
    <div class="hint">å‹¾é€‰ä½ æƒ³æ‰§è¡Œçš„å˜æ›´ï¼Œç„¶åç‚¹å‡»ã€Œç¡®è®¤å¹¶åº”ç”¨ã€ã€‚åº”ç”¨åå¯ç”¨ã€Œâ†© æ’¤å›ã€æ¢å¤ã€‚</div>
    <div class="form" id="proposalList" style="gap:8px;"></div>
    <div class="foot">
      <button class="btn" id="proposalCancelBtn">å…³é—­</button>
      <button class="btn primary" id="proposalApplyBtn">ç¡®è®¤å¹¶åº”ç”¨</button>
    </div>
  </dialog>


  <script>
    // --------- Data model ----------
    // state = {
    //   categories: [{id, name, collapsed}],
    //   sites: [{id, name, url, desc, catId, createdAt}],
    // }
    const STORAGE_KEY = "private_bookmarks_v1";

    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

    const defaultState = () => ({
      categories: [
        { id: uid(), name: "å­¦ä¹ ", collapsed: false },
        { id: uid(), name: "å·¥å…·", collapsed: false },
        { id: uid(), name: "é‡‘è", collapsed: false },
      ],
      sites: []
    });

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.categories) || !Array.isArray(parsed.sites)) return defaultState();
        // small repair: ensure fields exist
        parsed.categories = parsed.categories.map(c => ({
          id: c.id || uid(),
          name: c.name || "æœªå‘½å",
          collapsed: !!c.collapsed
        }));
        parsed.sites = parsed.sites.map(s => ({
          id: s.id || uid(),
          name: s.name || "æœªå‘½å",
          url: s.url || "",
          desc: s.desc || "",
          catId: s.catId || (parsed.categories[0]?.id ?? ""),
          createdAt: s.createdAt || Date.now()
        })).filter(s => s.url);
        // ensure at least one category
        if(parsed.categories.length === 0) parsed.categories.push({id: uid(), name:"é»˜è®¤", collapsed:false});
        return parsed;
      }catch(e){
        return defaultState();
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      // If GitHub sync configured, push changes (debounced)
      scheduleGhPush();
    }

    let pcb = null; // for import restore
    let state = loadState();

    // --------- UI refs ----------
    const grid = document.getElementById("grid");
    const q = document.getElementById("q");
    const stats = document.getElementById("stats");
    const toast = document.getElementById("toast");

    const addSiteBtn = document.getElementById("addSiteBtn");
    const addCatBtn = document.getElementById("addCatBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const ghSyncBtn = document.getElementById("ghSyncBtn");
    const ghSettingsBtn = document.getElementById("ghSettingsBtn");

    const ghDialog = document.getElementById("ghDialog");
    const closeGhDialog = document.getElementById("closeGhDialog");
    const ghForm = document.getElementById("ghForm");
    const ghOwner = document.getElementById("ghOwner");
    const ghRepo = document.getElementById("ghRepo");
    const ghBranch = document.getElementById("ghBranch");
    const ghPath = document.getElementById("ghPath");
    const ghToken = document.getElementById("ghToken");
    const ghRemember = document.getElementById("ghRemember");

    const resetBtn = document.getElementById("resetBtn");
    const clearBtn = document.getElementById("clearBtn");
    const fileInput = document.getElementById("fileInput");

    const siteDialog = document.getElementById("siteDialog");
    const siteDialogTitle = document.getElementById("siteDialogTitle");
    const closeSiteDialog = document.getElementById("closeSiteDialog");
    const siteForm = document.getElementById("siteForm");
    const siteId = document.getElementById("siteId");
    const siteName = document.getElementById("siteName");
    const siteCat = document.getElementById("siteCat");
    const siteUrl = document.getElementById("siteUrl");
    const siteDesc = document.getElementById("siteDesc");

    const catDialog = document.getElementById("catDialog");
    const catDialogTitle = document.getElementById("catDialogTitle");
    const closeCatDialog = document.getElementById("closeCatDialog");
    const catForm = document.getElementById("catForm");
    const catId = document.getElementById("catId");
    const catName = document.getElementById("catName");

    // --------- helpers ----------
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 1600);
    }

    function normalizeUrl(u){
      u = (u || "").trim();
      if(!u) return "";
      if(!/^https?:\/\//i.test(u)) u = "https://" + u;
      return u;
    }


    // --------- GitHub Sync (optional) ----------
    // Pure frontend cannot "log into GitHub" securely. We use PAT (token) you provide.
    // Config is stored locally in localStorage (token optional). Data syncs by reading/writing a JSON file in your repo via GitHub REST API.
    const GH_CFG_KEY = "private_bookmarks_github_cfg_v1";
    let ghSyncState = { status: "æœªé…ç½®", last: "" };
    let ghPushTimer = null;
    let ghRemoteSha = null; // for update file contents

    function getGhCfg(){
      try{
        const raw = localStorage.getItem(GH_CFG_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }
    function setGhCfg(cfg){
      localStorage.setItem(GH_CFG_KEY, JSON.stringify(cfg));
    }
    function getToken(cfg){
      if(!cfg) return "";
      if(cfg.rememberToken) return (cfg.token || "");
      // session only
      return sessionStorage.getItem("private_bookmarks_gh_token") || "";
    }
    function setToken(cfg, token){
      if(!cfg) return;
      if(cfg.rememberToken){
        cfg.token = token || "";
        setGhCfg(cfg);
      }else{
        sessionStorage.setItem("private_bookmarks_gh_token", token || "");
      }
    }
    function ghApiHeaders(token){
      const h = { "Accept": "application/vnd.github+json" };
      if(token) h["Authorization"] = "Bearer " + token;
      return h;
    }

    // Base64 helpers that correctly preserve Unicode (e.g., Chinese)
    function b64EncodeUnicode(str){
      return btoa(unescape(encodeURIComponent(str)));
    }
    function b64DecodeUnicode(b64){
      return decodeURIComponent(escape(atob(b64)));
    }
    function setGhStatus(status, last=""){
      ghSyncState.status = status;
      ghSyncState.last = last;
      // render stats line by re-rendering stats only (render() calls updateStats)
      updateStats(getShownCountForStats());
    }
    function getShownCountForStats(){
      // quick estimate: if search active, render() recomputes; here just show total sites
      return state.sites.length;
    }

    async function ghPull(){
      const cfg = getGhCfg();
      if(!cfg || !cfg.owner || !cfg.repo || !cfg.branch || !cfg.path){
        setGhStatus("æœªé…ç½®");
        return;
      }
      const token = getToken(cfg);
      if(!token){
        setGhStatus("ç¼ºå°‘ tokenï¼ˆç‚¹ GitHub è®¾ç½®ï¼‰");
        return;
      }
      setGhStatus("åŒæ­¥ä¸­â€¦");
      const url = `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${cfg.path}?ref=${encodeURIComponent(cfg.branch)}`;
      const res = await fetch(url, { headers: ghApiHeaders(token) });
      if(res.status === 404){
        // remote file not exist yet; push current local state to create
        ghRemoteSha = null;
        setGhStatus("è¿œç«¯æ— æ–‡ä»¶ï¼Œå‡†å¤‡åˆ›å»º");
        await ghPush(true);
        return;
      }
      if(!res.ok){
        const t = await res.text();
        setGhStatus("åŒæ­¥å¤±è´¥", `HTTP ${res.status}`);
        console.error("GitHub pull failed:", res.status, t);
        return;
      }
      const data = await res.json();
      ghRemoteSha = data.sha || null;
      const content = data.content ? b64DecodeUnicode(data.content.replace(/\n/g,"")) : "";
      let remoteState = null;
      try{ remoteState = JSON.parse(content); }catch(e){}
      if(!remoteState || !Array.isArray(remoteState.categories) || !Array.isArray(remoteState.sites)){
        setGhStatus("è¿œç«¯ JSON æ ¼å¼ä¸å¯¹");
        return;
      }
      // Replace local state with remote (simplest + deterministic). Backup current to allow undo by export.
      state = remoteState;
      // normalize similar to import
      state.categories = state.categories.map(c => ({
        id: c.id || uid(),
        name: c.name || "æœªå‘½å",
        collapsed: !!c.collapsed
      }));
      if(state.categories.length===0) state.categories.push({id:uid(), name:"é»˜è®¤", collapsed:false});
      const catIds = new Set(state.categories.map(c=>c.id));
      state.sites = state.sites.map(s => ({
        id: s.id || uid(),
        name: s.name || "æœªå‘½å",
        url: normalizeUrl(s.url || ""),
        desc: s.desc || "",
        catId: catIds.has(s.catId) ? s.catId : state.categories[0].id,
        createdAt: s.createdAt || Date.now()
      })).filter(s=>s.url);

      saveState();
      render();
      setGhStatus("å·²åŒæ­¥", new Date().toLocaleString());
      showToast("GitHub åŒæ­¥å®Œæˆ");
    }

    async function ghPush(isCreate=false){
      const cfg = getGhCfg();
      if(!cfg || !cfg.owner || !cfg.repo || !cfg.branch || !cfg.path){
        setGhStatus("æœªé…ç½®");
        return;
      }
      const token = getToken(cfg);
      if(!token){
        setGhStatus("ç¼ºå°‘ tokenï¼ˆç‚¹ GitHub è®¾ç½®ï¼‰");
        return;
      }
      setGhStatus("ä¸Šä¼ ä¸­â€¦");
      const apiUrl = `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${cfg.path}`;

      const payload = {
        message: `Update bookmarks (${new Date().toISOString()})`,
        content: b64EncodeUnicode(JSON.stringify(state, null, 2)),
        branch: cfg.branch
      };
      if(ghRemoteSha && !isCreate) payload.sha = ghRemoteSha;

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers: { ...ghApiHeaders(token), "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const t = await res.text();
        setGhStatus("ä¸Šä¼ å¤±è´¥", `HTTP ${res.status}`);
        console.error("GitHub push failed:", res.status, t);
        return;
      }
      const out = await res.json();
      ghRemoteSha = out?.content?.sha || ghRemoteSha;
      setGhStatus("å·²ä¸Šä¼ ", new Date().toLocaleString());
    }

    function scheduleGhPush(){
      const cfg = getGhCfg();
      if(!cfg) return;
      const token = getToken(cfg);
      if(!cfg.owner || !cfg.repo || !cfg.branch || !cfg.path || !token) return;

      clearTimeout(ghPushTimer);
      ghPushTimer = setTimeout(()=>{
        ghPush(false).catch(err=>{
          console.error(err);
          setGhStatus("ä¸Šä¼ å¤±è´¥");
        });
      }, 1200);
    }


    function matches(site, catName, query){
      if(!query) return true;
      const s = (site.name + " " + site.desc + " " + site.url + " " + (catName||"")).toLowerCase();
      return s.includes(query.toLowerCase());
    }

    function updateStats(filteredCount){
      const totalSites = state.sites.length;
      const totalCats = state.categories.length;
      const shown = filteredCount;
      const gh = getGhCfg();
      const ghText = ghSyncState.status + (ghSyncState.last ? ` Â· ${ghSyncState.last}` : "");
      stats.innerHTML = `
        <span>åˆ†ç±» <code>${totalCats}</code></span>
        <span>ç½‘ç«™ <code>${totalSites}</code></span>
        <span>å½“å‰æ˜¾ç¤º <code>${shown}</code></span>
        <span style="margin-left:auto;color:var(--muted)">GitHubï¼š<code>${ghText}</code></span>
      `;
    }

    function fillCategorySelect(selectedId){
      siteCat.innerHTML = "";
      state.categories.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        if(c.id === selectedId) opt.selected = true;
        siteCat.appendChild(opt);
      });
    }

    // --------- render ----------
    function render(){
      const query = q.value.trim();
      grid.innerHTML = "";

      // compute filtered counts for stats
      let shownSites = 0;

      state.categories.forEach(cat=>{
        const catSites = state.sites
          .filter(s => s.catId === cat.id)
          .filter(s => matches(s, cat.name, query))
          .sort((a,b)=> a.name.localeCompare(b.name, "zh-Hans-CN"));

        shownSites += catSites.length;

        // If query active and category has no results, hide category block
        if(query && catSites.length === 0) return;

        const wrap = document.createElement("div");
        wrap.className = "cat" + (cat.collapsed ? " collapsed" : "");

        const header = document.createElement("div");
        header.className = "cat-header";

        const left = document.createElement("div");
        left.className = "cat-left";

        const caret = document.createElement("div");
        caret.className = "caret";
        caret.innerHTML = "<span>â–¾</span>";
        caret.title = "æŠ˜å /å±•å¼€";
        caret.onclick = ()=>{
          cat.collapsed = !cat.collapsed;
          saveState();
          render();
        };

        const nameBox = document.createElement("div");
        nameBox.className = "cat-name";
        const count = state.sites.filter(s=>s.catId===cat.id).length;
        const shownCount = catSites.length;

        nameBox.innerHTML = `
          <strong>${escapeHtml(cat.name)}</strong>
          <small>${query ? `åŒ¹é… ${shownCount} / å…± ${count}` : `å…± ${count} ä¸ªç½‘ç«™`}</small>
        `;

        left.appendChild(caret);
        left.appendChild(nameBox);

        const actions = document.createElement("div");
        actions.className = "cat-actions";

        const addBtn = document.createElement("button");
        addBtn.className = "btn";
        addBtn.textContent = "+ æœ¬åˆ†ç±»æ·»åŠ ";
        addBtn.onclick = ()=> openSiteDialog({catId: cat.id});

        const editBtn = document.createElement("button");
        editBtn.className = "btn";
        editBtn.textContent = "æ”¹å";
        editBtn.onclick = ()=> openCatDialog(cat);

        const delBtn = document.createElement("button");
        delBtn.className = "btn danger";
        delBtn.textContent = "åˆ é™¤åˆ†ç±»";
        delBtn.onclick = ()=>{
          const ok = confirm(`ç¡®å®šåˆ é™¤åˆ†ç±»ã€Œ${cat.name}ã€å—ï¼Ÿè¯¥åˆ†ç±»ä¸‹çš„ç½‘ç«™ä¹Ÿä¼šä¸€èµ·åˆ é™¤ã€‚`);
          if(!ok) return;
          // remove
          state.sites = state.sites.filter(s=>s.catId!==cat.id);
          state.categories = state.categories.filter(c=>c.id!==cat.id);
          if(state.categories.length===0){
            state.categories.push({id: uid(), name:"é»˜è®¤", collapsed:false});
          }
          saveState();
          render();
          showToast("å·²åˆ é™¤åˆ†ç±»");
        };

        actions.appendChild(addBtn);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        header.appendChild(left);
        header.appendChild(actions);

        const sites = document.createElement("div");
        sites.className = "sites";

        catSites.forEach(site=>{
          const card = document.createElement("div");
          card.className = "card";

          const top = document.createElement("div");
          top.className = "top";

          const main = document.createElement("div");
          main.style.minWidth = "0";
          main.innerHTML = `
            <h3 title="${escapeHtml(site.name)}">${escapeHtml(site.name)}</h3>
            <p>${escapeHtml(site.desc || "ï¼ˆæ— æè¿°ï¼‰")}</p>
          `;

          const mini = document.createElement("div");
          mini.className = "mini-actions";

          // å³ä¸Šè§’åªä¿ç•™ï¼šç¼–è¾‘ / åˆ é™¤
          const editS = document.createElement("button");
          editS.className = "iconbtn";
          editS.title = "ç¼–è¾‘";
          editS.textContent = "âœ";
          editS.onclick = ()=> openSiteDialog(site);

          const delS = document.createElement("button");
          delS.className = "iconbtn danger";
          delS.title = "åˆ é™¤";
          delS.textContent = "ğŸ—‘";
          delS.onclick = ()=>{
            const ok = confirm(`åˆ é™¤ç½‘ç«™ã€Œ${site.name}ã€ï¼Ÿ`);
            if(!ok) return;
            state.sites = state.sites.filter(s=>s.id!==site.id);
            saveState();
            render();
            showToast("å·²åˆ é™¤ç½‘ç«™");
          };

          mini.appendChild(editS);
          mini.appendChild(delS);

          top.appendChild(main);
          top.appendChild(mini);

          const url = document.createElement("div");
          url.className = "url";
          url.textContent = site.url;

          // åº•éƒ¨å¤§æŒ‰é’®ï¼šè¿›å…¥ç½‘ç«™
          const openBig = document.createElement("a");
          openBig.className = "openbig";
          openBig.href = site.url;
          openBig.target = "_blank";
          openBig.rel = "noopener";
          openBig.innerHTML = `è¿›å…¥ç½‘ç«™ <span style="opacity:.85">â†—</span>`;

          card.appendChild(top);
          card.appendChild(url);
          card.appendChild(openBig);

          sites.appendChild(card);
        });

        wrap.appendChild(header);
        wrap.appendChild(sites);
        grid.appendChild(wrap);
      });

      updateStats(shownSites);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // --------- dialogs ----------
    function openSiteDialog(site){
      const isEdit = !!(site && site.id);
      siteDialogTitle.textContent = isEdit ? "ç¼–è¾‘ç½‘ç«™" : "æ·»åŠ ç½‘ç«™";
      siteId.value = isEdit ? site.id : "";
      siteName.value = site?.name || "";
      siteUrl.value = site?.url || "";
      siteDesc.value = site?.desc || "";
      fillCategorySelect(site?.catId || (state.categories[0]?.id ?? ""));
      siteDialog.showModal();
      setTimeout(()=>siteName.focus(), 50);
    }

    function openCatDialog(cat){
      const isEdit = !!(cat && cat.id);
      catDialogTitle.textContent = isEdit ? "ç¼–è¾‘åˆ†ç±»" : "æ·»åŠ åˆ†ç±»";
      catId.value = isEdit ? cat.id : "";
      catName.value = cat?.name || "";
      catDialog.showModal();
      setTimeout(()=>catName.focus(), 50);
    }

    closeSiteDialog.onclick = ()=> siteDialog.close();
    closeCatDialog.onclick = ()=> catDialog.close();

    siteForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const id = siteId.value.trim();
      const name = siteName.value.trim() || "æœªå‘½å";
      const url = normalizeUrl(siteUrl.value);
      if(!url){
        showToast("URL ä¸èƒ½ä¸ºç©º");
        return;
      }
      const desc = siteDesc.value.trim();
      const catIdVal = siteCat.value;

      if(id){
        const s = state.sites.find(x=>x.id===id);
        if(s){
          s.name = name; s.url = url; s.desc = desc; s.catId = catIdVal;
        }
        showToast("å·²ä¿å­˜ä¿®æ”¹");
      }else{
        state.sites.push({ id: uid(), name, url, desc, catId: catIdVal, createdAt: Date.now() });
        showToast("å·²æ·»åŠ ç½‘ç«™");
      }
      saveState();
      siteDialog.close();
      render();
    });

    catForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const id = catId.value.trim();
      const name = catName.value.trim() || "æœªå‘½å";
      if(id){
        const c = state.categories.find(x=>x.id===id);
        if(c) c.name = name;
        showToast("å·²æ›´æ–°åˆ†ç±»");
      }else{
        state.categories.push({ id: uid(), name, collapsed: false });
        showToast("å·²æ·»åŠ åˆ†ç±»");
      }
      saveState();
      catDialog.close();
      render();
    });

    // --------- top actions ----------
    addSiteBtn.onclick = ()=> openSiteDialog({catId: state.categories[0]?.id});
    addCatBtn.onclick = ()=> openCatDialog(null);

    clearBtn.onclick = ()=>{
      q.value = "";
      render();
      q.focus();
    };

    exportBtn.onclick = ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "my_bookmarks.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
      showToast("å·²å¯¼å‡º JSON");
    };

    importBtn.onclick = ()=> fileInput.click();


    // GitHub UI
    closeGhDialog.onclick = ()=> ghDialog.close();

    function openGhDialog(){
      const cfg = getGhCfg() || { owner:"", repo:"", branch:"main", path:"data/bookmarks.json", rememberToken:false };
      ghOwner.value = cfg.owner || "";
      ghRepo.value = cfg.repo || "";
      ghBranch.value = cfg.branch || "main";
      ghPath.value = cfg.path || "data/bookmarks.json";
      ghRemember.checked = !!cfg.rememberToken;
      // token: only fill if remembered
      ghToken.value = cfg.rememberToken ? (cfg.token || "") : "";
      ghDialog.showModal();
      setTimeout(()=>ghOwner.focus(), 50);
    }

    ghSettingsBtn.onclick = openGhDialog;

    ghForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const cfg = getGhCfg() || {};
      cfg.owner = (ghOwner.value || "").trim();
      cfg.repo = (ghRepo.value || "").trim();
      cfg.branch = (ghBranch.value || "main").trim();
      cfg.path = (ghPath.value || "data/bookmarks.json").trim();
      cfg.rememberToken = !!ghRemember.checked;

      const token = (ghToken.value || "").trim();
      // Save cfg first (token handled separately)
      if(cfg.rememberToken){
        cfg.token = token;
      }else{
        cfg.token = "";
      }
      setGhCfg(cfg);
      setToken(cfg, token);
      ghDialog.close();
      setGhStatus(cfg.owner && cfg.repo ? "å·²é…ç½®ï¼ˆå¯åŒæ­¥ï¼‰" : "æœªé…ç½®");
      showToast("GitHub è®¾ç½®å·²ä¿å­˜");
    });

    ghSyncBtn.onclick = ()=>{
      ghPull().catch(err=>{
        console.error(err);
        setGhStatus("åŒæ­¥å¤±è´¥");
        showToast("GitHub åŒæ­¥å¤±è´¥ï¼ˆæŸ¥çœ‹æ§åˆ¶å°ï¼‰");
      });
    };


    fileInput.addEventListener("change", async ()=>{
      const file = fileInput.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        if(!parsed || !Array.isArray(parsed.categories) || !Array.isArray(parsed.sites)){
          alert("JSON æ ¼å¼ä¸å¯¹ï¼šéœ€è¦åŒ…å« categories å’Œ sites æ•°ç»„ã€‚");
          return;
        }
        // backup for undo-ish
        pcb = JSON.stringify(state);
        state = parsed;
        // normalize
        state.categories = state.categories.map(c => ({
          id: c.id || uid(),
          name: c.name || "æœªå‘½å",
          collapsed: !!c.collapsed
        }));
        if(state.categories.length===0) state.categories.push({id:uid(), name:"é»˜è®¤", collapsed:false});
        const catIds = new Set(state.categories.map(c=>c.id));
        state.sites = state.sites.map(s => ({
          id: s.id || uid(),
          name: s.name || "æœªå‘½å",
          url: normalizeUrl(s.url || ""),
          desc: s.desc || "",
          catId: catIds.has(s.catId) ? s.catId : state.categories[0].id,
          createdAt: s.createdAt || Date.now()
        })).filter(s=>s.url);

        saveState();
        render();
        showToast("å·²å¯¼å…¥å¹¶ä¿å­˜");
      }catch(err){
        alert("å¯¼å…¥å¤±è´¥ï¼šä¸æ˜¯æœ‰æ•ˆ JSON æˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚");
      }finally{
        fileInput.value = "";
      }
    });

    resetBtn.onclick = ()=>{
      const ok = confirm("ç¡®å®šé‡ç½®å—ï¼Ÿå°†æ¸…ç©ºæ‰€æœ‰åˆ†ç±»å’Œç½‘ç«™ï¼ˆæ¢å¤é»˜è®¤æ¨¡æ¿ï¼‰ã€‚");
      if(!ok) return;
      state = defaultState();
      saveState();
      render();
      showToast("å·²é‡ç½®");
    };

    // search
    q.addEventListener("input", ()=> render());


    // --------- Assistant (Proposal-based) ----------
    const assistantFab = document.getElementById("assistantFab");
    const assistantPanel = document.getElementById("assistantPanel");
    const assistantClose = document.getElementById("assistantClose");
    const assistantBody = document.getElementById("assistantBody");
    const assistantInput = document.getElementById("assistantInput");
    const assistantSend = document.getElementById("assistantSend");
    const assistantReviewBtn = document.getElementById("assistantReviewBtn");
    const assistantApplyBtn = document.getElementById("assistantApplyBtn");
    const assistantDiscardBtn = document.getElementById("assistantDiscardBtn");
    const assistantUndoBtn = document.getElementById("assistantUndoBtn");

    const proposalDialog = document.getElementById("proposalDialog");
    const closeProposalDialog = document.getElementById("closeProposalDialog");
    const proposalCancelBtn = document.getElementById("proposalCancelBtn");
    const proposalApplyBtn = document.getElementById("proposalApplyBtn");
    const proposalList = document.getElementById("proposalList");

    // Configure your Worker endpoint (you will deploy it and paste the URL here)
    const ASSISTANT_ENDPOINT_KEY = "private_bookmarks_assistant_endpoint_v1";
    function getAssistantEndpoint(){
      return localStorage.getItem(ASSISTANT_ENDPOINT_KEY) || "";
    }
    function setAssistantEndpoint(url){
      localStorage.setItem(ASSISTANT_ENDPOINT_KEY, url || "");
    }

    // Undo stack (stores snapshots before applying proposals)
    const undoStack = [];
    function pushUndo(){
      undoStack.push(JSON.stringify(state));
      if(undoStack.length > 30) undoStack.shift();
    }
    function canUndo(){ return undoStack.length > 0; }
    function doUndo(){
      if(!canUndo()){
        showToast("æ²¡æœ‰å¯æ’¤å›çš„å˜æ›´");
        return;
      }
      try{
        const prev = JSON.parse(undoStack.pop());
        state = prev;
        saveState();
        render();
        showToast("å·²æ’¤å›");
      }catch(e){
        showToast("æ’¤å›å¤±è´¥");
      }
    }

    // Current proposal from assistant
    let pendingProposal = null; // {summary, changes:[], note?}
    let pendingChecked = null; // boolean[]

    function addMsg(role, text){
      const el = document.createElement("div");
      el.className = "msg " + (role === "user" ? "user" : "assistant");
      const b = document.createElement("div");
      b.className = "bubble";
      b.textContent = text;
      el.appendChild(b);
      assistantBody.appendChild(el);
      assistantBody.scrollTop = assistantBody.scrollHeight;
    }

    function enableProposalActions(enabled){
      assistantReviewBtn.disabled = !enabled;
      assistantApplyBtn.disabled = !enabled;
      assistantDiscardBtn.disabled = !enabled;
    }

    function discardProposal(){
      pendingProposal = null;
      pendingChecked = null;
      enableProposalActions(false);
      showToast("å·²ä¸¢å¼ƒææ¡ˆ");
    }

    function humanizeChange(ch){
      const op = ch.op;
      if(op === "addCategory") return `æ–°å¢åˆ†ç±»ï¼š${ch.name}`;
      if(op === "renameCategory") return `åˆ†ç±»æ”¹åï¼š${ch.from} â†’ ${ch.to}`;
      if(op === "deleteCategory") return `åˆ é™¤åˆ†ç±»ï¼š${ch.name}`;
      if(op === "addSite") return `æ–°å¢ç½‘ç«™ï¼š${ch.name}ï¼ˆ${ch.url}ï¼‰â†’ åˆ†ç±»ï¼š${ch.category}`;
      if(op === "updateSite") return `ç¼–è¾‘ç½‘ç«™ï¼š${ch.target}ï¼ˆæ”¹ ${Object.keys(ch.patch||{}).join(", ")}ï¼‰`;
      if(op === "deleteSite") return `åˆ é™¤ç½‘ç«™ï¼š${ch.target}`;
      if(op === "moveSite") return `ç§»åŠ¨ç½‘ç«™ï¼š${ch.target} â†’ åˆ†ç±»ï¼š${ch.toCategory}`;
      return `å˜æ›´ï¼š${op}`;
    }

    function openProposalDialog(){
      if(!pendingProposal) return;
      proposalList.innerHTML = "";
      const changes = pendingProposal.changes || [];
      pendingChecked = pendingChecked || changes.map(()=>true);

      // summary
      const summary = document.createElement("div");
      summary.className = "proposal-card";
      summary.innerHTML = `<strong>æ‘˜è¦</strong><div style="margin-top:6px;color:var(--muted)">${escapeHtml(pendingProposal.summary || "ï¼ˆæ— ï¼‰")}</div>`;
      proposalList.appendChild(summary);

      changes.forEach((ch, idx)=>{
        const box = document.createElement("div");
        box.style.display = "flex";
        box.style.gap = "10px";
        box.style.alignItems = "flex-start";
        box.style.padding = "10px";
        box.style.borderRadius = "14px";
        box.style.border = "1px solid rgba(255,255,255,.10)";
        box.style.background = "rgba(255,255,255,.03)";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!pendingChecked[idx];
        cb.style.width = "auto";
        cb.onchange = ()=>{ pendingChecked[idx] = cb.checked; };

        const txt = document.createElement("div");
        txt.style.flex = "1";
        txt.style.fontSize = "13px";
        txt.style.lineHeight = "1.35";
        txt.innerHTML = `<div>${escapeHtml(humanizeChange(ch))}</div>
          <div style="margin-top:6px;color:var(--muted);font-family:var(--mono);font-size:11px;white-space:pre-wrap">${escapeHtml(JSON.stringify(ch, null, 2))}</div>`;

        box.appendChild(cb);
        box.appendChild(txt);
        proposalList.appendChild(box);
      });

      proposalDialog.showModal();
    }

    closeProposalDialog.onclick = ()=> proposalDialog.close();
    proposalCancelBtn.onclick = ()=> proposalDialog.close();

    function findCategoryIdByName(name){
      const c = state.categories.find(x => x.name === name);
      return c ? c.id : null;
    }
    function ensureCategory(name){
      let id = findCategoryIdByName(name);
      if(id) return id;
      const newCat = { id: uid(), name, collapsed:false };
      state.categories.push(newCat);
      return newCat.id;
    }
    function findSiteByNameOrUrl(target){
      const t = (target||"").toLowerCase();
      return state.sites.find(s => (s.name||"").toLowerCase() === t || (s.url||"").toLowerCase() === t) || null;
    }

    function applyOneChange(ch){
      const op = ch.op;
      if(op === "addCategory"){
        ensureCategory(ch.name);
        return;
      }
      if(op === "renameCategory"){
        const c = state.categories.find(x=>x.name===ch.from);
        if(c) c.name = ch.to;
        return;
      }
      if(op === "deleteCategory"){
        const c = state.categories.find(x=>x.name===ch.name);
        if(!c) return;
        // delete sites in category too (consistent with UI)
        state.sites = state.sites.filter(s=>s.catId!==c.id);
        state.categories = state.categories.filter(x=>x.id!==c.id);
        if(state.categories.length===0) state.categories.push({id: uid(), name:"é»˜è®¤", collapsed:false});
        return;
      }
      if(op === "addSite"){
        const catId = ensureCategory(ch.category || "é»˜è®¤");
        const url = normalizeUrl(ch.url || "");
        if(!url) return;
        // de-dup by url
        const exists = state.sites.find(s=>s.url===url);
        if(exists){
          // update existing
          exists.name = ch.name || exists.name;
          exists.desc = ch.desc || exists.desc;
          exists.catId = catId;
        }else{
          state.sites.push({
            id: uid(),
            name: ch.name || "æœªå‘½å",
            url,
            desc: ch.desc || "",
            catId,
            createdAt: Date.now()
          });
        }
        return;
      }
      if(op === "updateSite"){
        const s = findSiteByNameOrUrl(ch.target);
        if(!s) return;
        const p = ch.patch || {};
        if(p.name !== undefined) s.name = p.name;
        if(p.desc !== undefined) s.desc = p.desc;
        if(p.url !== undefined) s.url = normalizeUrl(p.url);
        if(p.category !== undefined){
          s.catId = ensureCategory(p.category);
        }
        return;
      }
      if(op === "deleteSite"){
        const s = findSiteByNameOrUrl(ch.target);
        if(!s) return;
        state.sites = state.sites.filter(x=>x.id!==s.id);
        return;
      }
      if(op === "moveSite"){
        const s = findSiteByNameOrUrl(ch.target);
        if(!s) return;
        s.catId = ensureCategory(ch.toCategory || "é»˜è®¤");
        return;
      }
    }

    function applyProposalSelected(){
      if(!pendingProposal) return;
      const changes = pendingProposal.changes || [];
      const selected = changes.filter((_,i)=> pendingChecked ? pendingChecked[i] : true);
      if(selected.length === 0){
        showToast("æœªé€‰æ‹©ä»»ä½•å˜æ›´");
        return;
      }
      pushUndo();
      selected.forEach(ch=> applyOneChange(ch));
      // Normalize & persist
      saveState();
      render();
      showToast("å·²åº”ç”¨å˜æ›´ï¼ˆå¯æ’¤å›ï¼‰");
      proposalDialog.close();
      discardProposal();
    }

    proposalApplyBtn.onclick = applyProposalSelected;

    assistantUndoBtn.onclick = doUndo;

    assistantFab.onclick = ()=>{
      assistantPanel.classList.toggle("show");
      if(assistantPanel.classList.contains("show")){
        // First time: ask for endpoint if not set
        const ep = getAssistantEndpoint();
        if(!ep){
          addMsg("assistant", "ä½ è¿˜æ²¡é…ç½®åŠ©æ‰‹åç«¯ï¼ˆCloudflare Workerï¼‰ã€‚\nç­‰ä½ éƒ¨ç½²å¥½ Workerï¼ŒæŠŠå®ƒçš„ URL å¡«è¿›æ¥ï¼š\nåœ¨èŠå¤©æ¡†è¾“å…¥ï¼š/endpoint https://xxxx.workers.dev");
        }
        setTimeout(()=>assistantInput.focus(), 50);
      }
    };
    assistantClose.onclick = ()=> assistantPanel.classList.remove("show");

    assistantReviewBtn.onclick = openProposalDialog;
    assistantApplyBtn.onclick = ()=>{ openProposalDialog(); };
    assistantDiscardBtn.onclick = discardProposal;

    function getStateForAssistant(){
      // Send full state (works for personal-sized data). If it grows large, we can switch to a summarized view.
      return state;
    }

    async function callAssistant(userText){
      const ep = getAssistantEndpoint();
      if(!ep){
        addMsg("assistant", "è¿˜æ²¡è®¾ç½®åç«¯ URLã€‚\nè¯·å…ˆè¾“å…¥ï¼š/endpoint https://ä½ çš„workeråŸŸå");
        return;
      }
      // Always POST to `${ep}/chat`
      const url = ep.replace(/\/+$/,"") + "/chat";
      const payload = { instruction: userText, state: getStateForAssistant() };

      assistantSend.disabled = true;
      try{
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const t = await res.text();
          addMsg("assistant", `è¯·æ±‚å¤±è´¥ï¼šHTTP ${res.status}\n${t}`);
          return;
        }
        const data = await res.json();
        // Expect: {summary, changes, assistant_message}
        const msg = data.assistant_message || data.summary || "å·²ç”Ÿæˆææ¡ˆã€‚";
        addMsg("assistant", msg);

        if(Array.isArray(data.changes)){
          pendingProposal = {
            summary: data.summary || "ï¼ˆæ— æ‘˜è¦ï¼‰",
            changes: data.changes
          };
          pendingChecked = data.changes.map(()=>true);
          enableProposalActions(true);
          showToast("å·²æ”¶åˆ°å˜æ›´ææ¡ˆï¼ˆéœ€ä½ ç¡®è®¤ï¼‰");
        }else{
          enableProposalActions(false);
        }
      }catch(e){
        addMsg("assistant", "è¯·æ±‚å¤±è´¥ï¼šç½‘ç»œæˆ–åç«¯é”™è¯¯ã€‚");
      }finally{
        assistantSend.disabled = false;
      }
    }

    function handleAssistantCommand(text){
      const t = text.trim();
      if(t.startsWith("/endpoint")){
        const parts = t.split(/\s+/);
        const url = parts[1] || "";
        if(!url || !/^https?:\/\//i.test(url)){
          addMsg("assistant", "ç”¨æ³•ï¼š/endpoint https://xxxx.workers.dev");
          return true;
        }
        setAssistantEndpoint(url);
        addMsg("assistant", "å·²ä¿å­˜åç«¯åœ°å€ã€‚ç°åœ¨å¯ä»¥ç›´æ¥è¾“å…¥è‡ªç„¶è¯­è¨€è®©æˆ‘æå‡ºæ•´ç†æ–¹æ¡ˆã€‚");
        return true;
      }
      return false;
    }

    assistantSend.onclick = ()=>{
      const text = assistantInput.value.trim();
      if(!text) return;
      assistantInput.value = "";
      addMsg("user", text);
      if(handleAssistantCommand(text)) return;
      callAssistant(text);
    };

    assistantInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        assistantSend.click();
      }
    });

    // keyboard shortcuts
    window.addEventListener("keydown", (e)=>{
      if(e.key === "/" && document.activeElement !== q){
        e.preventDefault();
        q.focus();
      }
      if(e.key === "Escape"){
        if(siteDialog.open) siteDialog.close();
        else if(catDialog.open) catDialog.close();
        else if(proposalDialog.open) proposalDialog.close();
        else if(assistantPanel.classList.contains("show")) assistantPanel.classList.remove("show");
        else{
          q.value = "";
          render();
        }
      }
    });

    // initial render
    const initCfg = getGhCfg();
    if(initCfg && initCfg.owner && initCfg.repo && initCfg.branch && initCfg.path){
      setGhStatus("å·²é…ç½®ï¼ˆæœªåŒæ­¥ï¼‰");
      // Auto pull once on load if token exists (session or remembered)
      const tok = getToken(initCfg);
      if(tok){
        ghPull().catch(()=>setGhStatus("åŒæ­¥å¤±è´¥"));
      }else{
        setGhStatus("ç¼ºå°‘ tokenï¼ˆç‚¹ GitHub è®¾ç½®ï¼‰");
      }
    }else{
      setGhStatus("æœªé…ç½®");
    }
    render();
  </script>
</body>
</html>
